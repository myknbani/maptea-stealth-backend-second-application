name: Node.js CI/CD

on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

jobs:
  quality_assurance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run linter
        run: pnpm lint

      - name: Run type check
        run: pnpm qa:typecheck

      - name: Run tests
        run: pnpm test

  deploy:
    runs-on: ubuntu-latest
    needs: quality_assurance
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-southeast-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: maptea-backend
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Deploy to Lightsail
        env:
          SERVICE_NAME: maptea-assessment
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: maptea-backend
          IMAGE_TAG: ${{ github.sha }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          # Use jq to properly construct JSON
          CONTAINERS=$(jq -n \
            --arg image "$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            --arg db_url "$DATABASE_URL" \
            --arg jwt "$JWT_SECRET" \
            '{
              backend: {
                image: $image,
                environment: {
                  NODE_ENV: "production",
                  DATABASE_URL: $db_url,
                  JWT_SECRET: $jwt,
                  DATABASE_SSL: "true",
                  JWT_EXPIRATION: "7d"
                },
                ports: {
                  "3001": "HTTP"
                }
              }
            }')

          PUBLIC_ENDPOINT=$(jq -n \
            '{
              containerName: "backend",
              containerPort: 3001,
              healthCheck: {
                healthyThreshold: 2,
                unhealthyThreshold: 2,
                timeoutSeconds: 5,
                intervalSeconds: 10,
                path: "/",
                successCodes: "200-299"
              }
            }')

          aws lightsail create-container-service-deployment \
            --region ap-southeast-1 \
            --service-name $SERVICE_NAME \
            --output yaml \
            --containers "$CONTAINERS" \
            --public-endpoint "$PUBLIC_ENDPOINT"
